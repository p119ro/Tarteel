<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Tarteel â€” Quran Memorization</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Noto+Naskh+Arabic:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --emerald-50: #ecfdf5;
    --emerald-100: #d1fae5;
    --emerald-200: #a7f3d0;
    --emerald-300: #6ee7b7;
    --emerald-400: #34d399;
    --emerald-500: #10b981;
    --emerald-600: #059669;
    --emerald-700: #047857;
    --emerald-800: #065f46;
    --emerald-900: #064e3b;
    --emerald-950: #022c22;
    --white: #ffffff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --orange-500: #f97316;
    --orange-100: #ffedd5;
    --amber-500: #f59e0b;
    --red-50: #fef2f2;
    --red-200: #fecaca;
    --red-800: #991b1b;
    --radius: 20px;
    --radius-sm: 14px;
    --radius-xs: 10px;
    --shadow: 0 2px 16px rgba(6, 78, 59, 0.06), 0 0 0 1px rgba(6, 78, 59, 0.03);
    --shadow-md: 0 4px 24px rgba(6, 78, 59, 0.08), 0 0 0 1px rgba(6, 78, 59, 0.04);
    --shadow-lg: 0 12px 40px rgba(6, 78, 59, 0.12);
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: #f0fdf8;
    color: var(--emerald-950);
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
  }

  /* â”€â”€ Ambient Background â”€â”€ */
  .ambient-bg {
    position: fixed; inset: 0; pointer-events: none; z-index: 0;
  }
  .ambient-bg::before {
    content: '';
    position: absolute; top: -30%; right: -20%; width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(16, 185, 129, 0.08) 0%, transparent 70%);
    border-radius: 50%;
  }
  .ambient-bg::after {
    content: '';
    position: absolute; bottom: -20%; left: -15%; width: 500px; height: 500px;
    background: radial-gradient(circle, rgba(4, 120, 87, 0.05) 0%, transparent 70%);
    border-radius: 50%;
  }
  .geometric-bg {
    position: fixed; inset: 0; opacity: 0.018;
    background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' stroke='%23047857' stroke-width='0.8'%3E%3Cpath d='M40 0L80 40L40 80L0 40Z'/%3E%3Cpath d='M40 10L70 40L40 70L10 40Z'/%3E%3Cpath d='M40 20L60 40L40 60L20 40Z'/%3E%3C/g%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }

  #app {
    position: relative; z-index: 1; max-width: 520px;
    margin: 0 auto; min-height: 100vh; padding: 16px 16px 40px;
  }

  /* â”€â”€ Header â”€â”€ */
  .app-header {
    text-align: center; padding: 20px 0 8px; animation: fadeDown 0.6s ease;
  }
  .app-header .logo-icon {
    width: 48px; height: 48px;
    background: linear-gradient(145deg, var(--emerald-500), var(--emerald-700));
    border-radius: 16px; display: inline-flex; align-items: center; justify-content: center;
    margin-bottom: 10px;
    box-shadow: 0 6px 24px rgba(4, 120, 87, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
  }
  .app-header .logo-icon svg { width: 24px; height: 24px; fill: var(--white); }
  .app-header h1 {
    font-family: 'Amiri', serif; font-size: 1.8rem; font-weight: 700;
    color: var(--emerald-800); letter-spacing: -0.3px;
  }
  .app-header p {
    font-size: 0.78rem; color: var(--emerald-600); margin-top: 2px;
    font-weight: 500; letter-spacing: 0.2px;
  }

  /* â”€â”€ Floating Bottom Nav â”€â”€ */
  .bottom-nav {
    position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
    width: calc(100% - 40px); max-width: 480px;
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(16, 185, 129, 0.12);
    border-radius: 22px;
    display: flex;
    z-index: 50;
    padding: 6px 8px;
    box-shadow: 0 8px 32px rgba(6, 78, 59, 0.1), 0 0 0 1px rgba(255,255,255,0.5) inset;
  }
  .nav-item {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 10px 4px 8px; cursor: pointer; border: none; background: none;
    font-family: 'Plus Jakarta Sans', sans-serif; transition: var(--transition); gap: 4px;
    position: relative; border-radius: 16px;
  }
  .nav-item::before {
    content: ''; position: absolute; inset: 4px; border-radius: 14px;
    background: transparent; transition: var(--transition); z-index: -1;
  }
  .nav-item.active::before { background: var(--emerald-100); }
  .nav-item svg { width: 21px; height: 21px; fill: var(--gray-400); transition: var(--transition); }
  .nav-item span {
    font-size: 0.62rem; font-weight: 700; color: var(--gray-400);
    transition: var(--transition); letter-spacing: 0.3px;
  }
  .nav-item.active svg { fill: var(--emerald-700); }
  .nav-item.active span { color: var(--emerald-700); }
  .nav-item:not(.active):hover::before { background: rgba(16, 185, 129, 0.05); }
  .nav-badge {
    position: absolute; top: 4px; right: 50%; transform: translateX(16px);
    min-width: 17px; height: 17px; background: var(--orange-500); color: var(--white);
    font-size: 0.58rem; font-weight: 800; border-radius: 9px;
    display: flex; align-items: center; justify-content: center; padding: 0 5px;
    box-shadow: 0 2px 8px rgba(249, 115, 22, 0.35);
  }

  /* â”€â”€ Cards â”€â”€ */
  .card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: var(--radius);
    padding: 22px;
    box-shadow: var(--shadow);
    margin-bottom: 12px;
    border: 1px solid rgba(16, 185, 129, 0.06);
    animation: fadeUp 0.5s ease;
  }
  .card-title {
    font-size: 0.68rem; font-weight: 800; text-transform: uppercase;
    letter-spacing: 1.4px; color: var(--emerald-600); margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }
  .card-title .icon {
    width: 22px; height: 22px; background: var(--emerald-100); border-radius: 7px;
    display: flex; align-items: center; justify-content: center; font-size: 0.7rem;
  }

  /* â”€â”€ Buttons â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    height: 50px; padding: 0 26px; border: none; border-radius: var(--radius-xs);
    font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.9rem; font-weight: 700;
    cursor: pointer; transition: var(--transition); white-space: nowrap;
    letter-spacing: 0.1px;
  }
  .btn-primary {
    background: linear-gradient(145deg, var(--emerald-500), var(--emerald-700));
    color: var(--white);
    box-shadow: 0 4px 16px rgba(4, 120, 87, 0.25), inset 0 1px 0 rgba(255,255,255,0.15);
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(4, 120, 87, 0.35); }
  .btn-primary:active { transform: translateY(0) scale(0.98); }
  .btn-primary:disabled { opacity: 0.45; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-secondary { background: var(--emerald-100); color: var(--emerald-700); }
  .btn-secondary:hover { background: var(--emerald-200); }
  .btn-outline { background: transparent; color: var(--emerald-700); border: 2px solid var(--emerald-200); }
  .btn-outline:hover { background: var(--emerald-50); border-color: var(--emerald-400); }
  .btn-full { width: 100%; }
  .btn-sm { height: 42px; padding: 0 20px; font-size: 0.82rem; }
  .btn-xs { height: 36px; padding: 0 16px; font-size: 0.78rem; border-radius: 10px; }

  /* â”€â”€ Input â”€â”€ */
  .input-field {
    width: 100%; height: 50px; border: 2px solid var(--emerald-200); border-radius: var(--radius-xs);
    padding: 0 16px; font-size: 1rem; font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700;
    color: var(--emerald-900); background: rgba(236, 253, 245, 0.6); outline: none;
    transition: var(--transition); text-align: center;
  }
  .input-field:focus {
    border-color: var(--emerald-500); background: var(--white);
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
  }
  .input-field::placeholder { color: var(--gray-400); font-weight: 400; }

  .reciter-select {
    width: 100%; height: 48px; border: 2px solid var(--emerald-200); border-radius: var(--radius-xs);
    padding: 0 14px; font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.86rem; font-weight: 600;
    color: var(--emerald-900); background: rgba(236, 253, 245, 0.6); outline: none; cursor: pointer;
    transition: var(--transition); margin-bottom: 10px; appearance: none; -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='%23047857'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 14px center;
  }
  .reciter-select:focus { border-color: var(--emerald-500); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }

  .page-selector { display: flex; align-items: center; gap: 10px; }
  .page-selector .input-field { flex: 1; }

  /* â”€â”€ Streak â”€â”€ */
  .streak-banner {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #fff7ed, #fffbeb);
    border-radius: var(--radius-sm); margin-bottom: 12px;
    border: 1px solid rgba(251, 191, 36, 0.2);
    box-shadow: 0 2px 12px rgba(245, 158, 11, 0.06);
  }
  .streak-banner .flame { font-size: 1.3rem; }
  .streak-banner .streak-text { font-size: 0.86rem; font-weight: 700; color: #9a3412; }
  .streak-banner .streak-text small { display: block; font-size: 0.7rem; font-weight: 600; color: #c2410c; margin-top: 1px; }

  /* â”€â”€ Quick Continue â”€â”€ */
  .quick-continue {
    display: flex; align-items: center; gap: 14px; padding: 16px 20px;
    background: linear-gradient(145deg, var(--emerald-600), var(--emerald-800));
    border-radius: var(--radius); margin-bottom: 12px; cursor: pointer; transition: var(--transition);
    box-shadow: 0 6px 24px rgba(4, 120, 87, 0.25), inset 0 1px 0 rgba(255,255,255,0.1);
    border: none; width: 100%; text-align: left;
  }
  .quick-continue:hover { transform: translateY(-2px); box-shadow: 0 10px 32px rgba(4, 120, 87, 0.35); }
  .quick-continue:active { transform: translateY(0) scale(0.99); }
  .quick-continue .qc-icon {
    width: 44px; height: 44px; min-width: 44px; background: rgba(255,255,255,0.15);
    border-radius: 14px; display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(8px);
  }
  .quick-continue .qc-icon svg { width: 20px; height: 20px; fill: var(--white); }
  .quick-continue .qc-text h4 { font-size: 0.9rem; color: var(--white); font-weight: 700; font-family: 'Plus Jakarta Sans', sans-serif; }
  .quick-continue .qc-text p { font-size: 0.76rem; color: rgba(255,255,255,0.7); margin-top: 2px; font-family: 'Plus Jakarta Sans', sans-serif; }
  .quick-continue .qc-arrow { margin-left: auto; }
  .quick-continue .qc-arrow svg { width: 20px; height: 20px; fill: rgba(255,255,255,0.5); }

  /* â”€â”€ Review banner â”€â”€ */
  .review-banner {
    display: flex; align-items: center; gap: 12px; padding: 14px 18px;
    background: linear-gradient(135deg, #fffbeb, #fef3c7);
    border: 1px solid rgba(251, 191, 36, 0.2); border-radius: var(--radius-sm);
    margin-bottom: 12px; cursor: pointer; transition: var(--transition);
    box-shadow: 0 2px 12px rgba(245, 158, 11, 0.06);
  }
  .review-banner:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(245, 158, 11, 0.1); }
  .review-banner .rb-icon { font-size: 1.15rem; }
  .review-banner .rb-text { font-size: 0.84rem; font-weight: 700; color: #92400e; }
  .review-banner .rb-text small { display: block; font-size: 0.72rem; font-weight: 600; color: #b45309; margin-top: 1px; }
  .review-banner .rb-arrow { margin-left: auto; font-size: 1rem; color: #b45309; }

  /* â”€â”€ Goal â”€â”€ */
  .goal-bar { margin-top: 10px; }
  .goal-bar .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .goal-bar .goal-header span { font-size: 0.76rem; font-weight: 700; color: var(--emerald-700); }
  .goal-bar .goal-header small { font-size: 0.72rem; color: var(--gray-500); font-weight: 600; }
  .goal-track { width: 100%; height: 6px; background: var(--emerald-100); border-radius: 6px; overflow: hidden; }
  .goal-fill {
    height: 100%; border-radius: 6px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(90deg, var(--emerald-400), var(--emerald-600));
  }

  /* â”€â”€ Checklist â”€â”€ */
  .checklist-item {
    display: flex; align-items: flex-start; gap: 14px; padding: 14px 16px;
    border-radius: var(--radius-sm); background: rgba(249, 250, 251, 0.8);
    margin-bottom: 10px; border: 2px solid transparent;
    transition: var(--transition); cursor: pointer;
  }
  .checklist-item:hover { background: var(--emerald-50); }
  .checklist-item.completed { background: rgba(209, 250, 229, 0.4); border-color: var(--emerald-300); }
  .checklist-item .check-circle {
    width: 26px; height: 26px; min-width: 26px; border-radius: 50%;
    border: 2.5px solid var(--gray-300); display: flex; align-items: center;
    justify-content: center; transition: var(--transition-bounce); margin-top: 2px;
  }
  .checklist-item.completed .check-circle {
    background: var(--emerald-500); border-color: var(--emerald-500);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }
  .checklist-item .check-circle svg { width: 13px; height: 13px; fill: var(--white); opacity: 0; transition: var(--transition); }
  .checklist-item.completed .check-circle svg { opacity: 1; }
  .checklist-item .check-label h4 { font-size: 0.9rem; font-weight: 700; color: var(--emerald-900); margin-bottom: 3px; }
  .checklist-item .check-label p { font-size: 0.77rem; color: var(--gray-500); line-height: 1.4; }

  /* â”€â”€ Listen â”€â”€ */
  .listen-counter { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
  .listen-dots { display: flex; gap: 8px; }
  .listen-dot {
    width: 28px; height: 28px; border-radius: 50%; border: 2.5px solid var(--gray-300);
    background: var(--white); display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: 800; color: var(--gray-400); transition: var(--transition-bounce);
  }
  .listen-dot.filled {
    background: var(--emerald-500); border-color: var(--emerald-500); color: var(--white);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }
  .audio-player-mini {
    display: flex; align-items: center; gap: 10px; margin-top: 12px; padding: 10px 14px;
    background: rgba(236, 253, 245, 0.6); border-radius: var(--radius-xs);
    border: 1px solid var(--emerald-200);
  }
  .audio-player-mini .play-btn {
    width: 36px; height: 36px; min-width: 36px; border-radius: 50%;
    background: linear-gradient(145deg, var(--emerald-500), var(--emerald-700));
    border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: var(--transition);
    box-shadow: 0 2px 10px rgba(4, 120, 87, 0.25);
  }
  .audio-player-mini .play-btn:hover { transform: scale(1.08); }
  .audio-player-mini .play-btn:active { transform: scale(0.95); }
  .audio-player-mini .play-btn svg { width: 14px; height: 14px; fill: var(--white); }
  .audio-player-mini .audio-info { flex: 1; font-size: 0.79rem; color: var(--emerald-700); font-weight: 600; }
  .audio-player-mini .audio-info small { display: block; color: var(--gray-400); font-size: 0.69rem; font-weight: 500; margin-top: 1px; }
  .mark-listened-btn {
    height: 34px; padding: 0 14px; border: 2px solid var(--emerald-300); border-radius: 10px;
    background: var(--white); color: var(--emerald-700); font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.74rem; font-weight: 700; cursor: pointer; transition: var(--transition);
  }
  .mark-listened-btn:hover { background: var(--emerald-100); border-color: var(--emerald-400); }

  /* â”€â”€ Quran text â”€â”€ */
  .quran-text-container {
    background: var(--white); border-radius: var(--radius); padding: 28px 22px;
    margin: 14px 0; border: 1px solid var(--emerald-200);
    box-shadow: var(--shadow-md);
    position: relative; overflow: hidden;
  }
  .quran-text-container::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, var(--emerald-400), var(--emerald-600), var(--emerald-400));
    opacity: 0.8;
  }
  .quran-text {
    font-family: 'Noto Naskh Arabic', 'Amiri', serif; font-size: 1.5rem; line-height: 2.5;
    text-align: right; direction: rtl; color: var(--emerald-950); word-spacing: 4px;
  }
  .quran-text .ayah-number {
    display: inline-flex; align-items: center; justify-content: center;
    width: 26px; height: 26px; border-radius: 50%; border: 1.5px solid var(--emerald-300);
    font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.6rem; font-weight: 800;
    color: var(--emerald-600); margin: 0 3px; vertical-align: middle; background: var(--emerald-50);
  }
  .surah-header-display {
    text-align: center; padding: 14px;
    margin-bottom: 14px;
    background: linear-gradient(135deg, rgba(236, 253, 245, 0.6), rgba(209, 250, 229, 0.4));
    border-radius: var(--radius-sm); border: 1px solid var(--emerald-200);
  }
  .surah-header-display h3 { font-family: 'Amiri', serif; font-size: 1.2rem; color: var(--emerald-800); font-weight: 700; }
  .surah-header-display p { font-size: 0.74rem; color: var(--emerald-600); margin-top: 2px; font-weight: 500; }
  .bismillah {
    font-family: 'Noto Naskh Arabic', 'Amiri', serif; text-align: center;
    font-size: 1.3rem; color: var(--emerald-700); padding: 10px 0 14px; direction: rtl;
  }

  /* â”€â”€ Mem tracker â”€â”€ */
  .mem-tracker { text-align: center; padding: 22px; }
  .mem-stage-label {
    font-size: 0.68rem; font-weight: 800; text-transform: uppercase;
    letter-spacing: 1.8px; color: var(--emerald-600); margin-bottom: 4px;
  }
  .mem-section-label { font-family: 'Amiri', serif; font-size: 1.1rem; color: var(--emerald-900); margin-bottom: 18px; }
  .counter-display { display: flex; align-items: baseline; justify-content: center; gap: 6px; margin: 18px 0; }
  .counter-number {
    font-size: 3.4rem; font-weight: 800; color: var(--emerald-700);
    line-height: 1; font-variant-numeric: tabular-nums; letter-spacing: -1px;
  }
  .counter-total { font-size: 1.05rem; color: var(--gray-400); font-weight: 600; }

  /* â”€â”€ Counter Button (redesigned) â”€â”€ */
  .counter-btn {
    width: 100%; height: 62px; border: none; border-radius: var(--radius-sm);
    background: linear-gradient(145deg, var(--emerald-500), var(--emerald-700));
    color: var(--white); font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.95rem; font-weight: 700; letter-spacing: 0.2px;
    cursor: pointer; transition: var(--transition);
    box-shadow: 0 4px 20px rgba(4, 120, 87, 0.28), inset 0 1px 0 rgba(255,255,255,0.15);
    display: flex; align-items: center; justify-content: center;
    margin-top: 14px; position: relative; overflow: hidden;
    text-align: center;
  }
  .counter-btn::after {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(145deg, rgba(255,255,255,0.12), transparent 60%);
    pointer-events: none;
  }
  .counter-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(4, 120, 87, 0.35); }
  .counter-btn:active { transform: translateY(0) scale(0.97); box-shadow: 0 2px 12px rgba(4, 120, 87, 0.2); }

  .progress-bar-container {
    width: 100%; height: 8px; background: var(--emerald-100);
    border-radius: 8px; overflow: hidden; margin: 14px 0 6px;
  }
  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--emerald-400), var(--emerald-600));
    border-radius: 8px; transition: width 0.4s ease;
  }
  .progress-info { display: flex; justify-content: space-between; font-size: 0.74rem; color: var(--gray-500); font-weight: 600; }

  .stage-progress { display: flex; align-items: center; justify-content: center; gap: 6px; margin: 16px 0; }
  .stage-dot {
    width: 10px; height: 10px; border-radius: 50%; background: var(--emerald-200);
    transition: var(--transition-bounce);
  }
  .stage-dot.active {
    background: var(--emerald-500); width: 12px; height: 12px;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
  }
  .stage-dot.completed { background: var(--emerald-600); }
  .stage-line { width: 24px; height: 2px; background: var(--emerald-200); border-radius: 2px; }
  .stage-line.completed { background: var(--emerald-500); }

  .sections-nav { display: flex; gap: 6px; margin-bottom: 14px; flex-wrap: wrap; }
  .section-tab {
    flex: 1; min-width: 55px; height: 36px; border: 2px solid var(--emerald-200);
    border-radius: var(--radius-xs); background: var(--white); font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.7rem; font-weight: 700; color: var(--emerald-600); cursor: default;
    transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 3px;
  }
  .section-tab.active {
    background: var(--emerald-600); border-color: var(--emerald-600); color: var(--white);
    box-shadow: 0 2px 8px rgba(5, 150, 105, 0.25);
  }
  .section-tab.completed { background: var(--emerald-100); border-color: var(--emerald-400); color: var(--emerald-700); }
  .section-tab .check-sm { width: 13px; height: 13px; fill: currentColor; }

  /* â”€â”€ Grid â”€â”€ */
  .completion-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 3px; margin: 12px 0; }
  .grid-cell {
    aspect-ratio: 1; border-radius: 3px; background: var(--emerald-100);
    transition: var(--transition-bounce); cursor: pointer; position: relative; border: none; padding: 0; font-size: 0;
  }
  .grid-cell.memorized { background: var(--emerald-500); }
  .grid-cell.review-due { background: var(--amber-500); }
  .grid-cell:hover { transform: scale(1.8); z-index: 2; border-radius: 2px; }
  .grid-cell .tooltip {
    display: none; position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%);
    background: var(--emerald-900); color: var(--white); font-size: 0.66rem; font-family: 'Plus Jakarta Sans', sans-serif;
    padding: 4px 8px; border-radius: 6px; white-space: nowrap; font-weight: 600; pointer-events: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .grid-cell:hover .tooltip { display: block; }
  .grid-legend { display: flex; gap: 14px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
  .grid-legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; color: var(--gray-500); font-weight: 600; }
  .grid-legend-item .swatch { width: 10px; height: 10px; border-radius: 3px; }

  /* â”€â”€ Progress list â”€â”€ */
  .progress-tabs { display: flex; gap: 6px; margin-bottom: 14px; }
  .progress-tab {
    flex: 1; height: 38px; border: 2px solid var(--emerald-200); border-radius: var(--radius-xs);
    background: var(--white); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.8rem;
    font-weight: 700; color: var(--emerald-600); cursor: pointer; transition: var(--transition);
  }
  .progress-tab.active {
    background: var(--emerald-600); border-color: var(--emerald-600); color: var(--white);
    box-shadow: 0 2px 8px rgba(5, 150, 105, 0.25);
  }
  .progress-list-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 14px; border-bottom: 1px solid rgba(229, 231, 235, 0.5); transition: var(--transition);
  }
  .progress-list-item:last-child { border-bottom: none; }
  .progress-list-item .pli-name { font-size: 0.86rem; font-weight: 700; color: var(--emerald-900); }
  .progress-list-item .pli-detail { font-size: 0.73rem; color: var(--gray-400); margin-top: 1px; font-weight: 500; }
  .pli-bar { width: 90px; display: flex; align-items: center; gap: 8px; }
  .pli-bar-track { flex: 1; height: 5px; background: var(--emerald-100); border-radius: 5px; overflow: hidden; }
  .pli-bar-fill { height: 100%; background: var(--emerald-500); border-radius: 5px; }
  .pli-bar-pct { font-size: 0.72rem; font-weight: 800; color: var(--emerald-600); min-width: 32px; text-align: right; }

  /* â”€â”€ Review hidden text â”€â”€ */
  .text-hidden-overlay {
    position: relative; min-height: 120px; display: flex; align-items: center; justify-content: center;
    background: rgba(236, 253, 245, 0.5); border-radius: var(--radius-sm);
    border: 2px dashed var(--emerald-300);
    cursor: pointer; transition: var(--transition); padding: 20px;
  }
  .text-hidden-overlay:hover { background: var(--emerald-100); border-color: var(--emerald-400); }
  .text-hidden-overlay .reveal-text { text-align: center; color: var(--emerald-600); }
  .text-hidden-overlay .reveal-text svg { width: 32px; height: 32px; fill: var(--emerald-400); margin-bottom: 8px; display: block; margin: 0 auto 8px; }
  .text-hidden-overlay .reveal-text p { font-size: 0.86rem; font-weight: 700; }
  .text-hidden-overlay .reveal-text small { font-size: 0.74rem; color: var(--gray-400); font-weight: 500; }

  .review-actions { display: flex; gap: 10px; margin-top: 16px; }
  .review-actions .btn { flex: 1; }

  .review-card {
    background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px);
    border-radius: var(--radius); padding: 22px;
    box-shadow: var(--shadow-md); margin-bottom: 14px;
    border: 2px solid rgba(251, 191, 36, 0.2);
  }

  .info-box {
    display: flex; gap: 10px; padding: 12px 14px;
    background: rgba(236, 253, 245, 0.5); border-radius: var(--radius-xs);
    border: 1px solid var(--emerald-200); margin: 10px 0;
  }
  .info-box p { font-size: 0.79rem; color: var(--emerald-700); line-height: 1.5; font-weight: 500; }
  .error-msg {
    background: var(--red-50); border: 1px solid var(--red-200); color: var(--red-800);
    padding: 12px 16px; border-radius: var(--radius-xs); font-size: 0.82rem; margin: 10px 0; display: none;
    font-weight: 600;
  }
  .surah-segment-card {
    background: rgba(236, 253, 245, 0.5); border: 2px solid var(--emerald-200);
    border-radius: var(--radius-sm); padding: 14px 16px; margin-bottom: 10px;
    cursor: pointer; transition: var(--transition);
  }
  .surah-segment-card:hover { border-color: var(--emerald-400); background: var(--emerald-100); transform: translateY(-1px); }
  .surah-segment-card h4 { font-family: 'Amiri', serif; font-size: 1rem; color: var(--emerald-800); margin-bottom: 3px; }
  .surah-segment-card p { font-size: 0.77rem; color: var(--emerald-600); font-weight: 500; }
  .back-btn {
    display: inline-flex; align-items: center; gap: 5px; background: none; border: none;
    color: var(--emerald-600); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.82rem;
    font-weight: 700; cursor: pointer; padding: 8px 0; margin-bottom: 4px; transition: var(--transition);
  }
  .back-btn:hover { color: var(--emerald-800); }
  .back-btn svg { width: 18px; height: 18px; fill: currentColor; }
  .reset-row { display: flex; justify-content: center; margin-top: 10px; }
  .reset-btn {
    background: none; border: none; color: var(--gray-400); font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.74rem; font-weight: 600; cursor: pointer; padding: 5px 10px; transition: var(--transition);
  }
  .reset-btn:hover { color: #ef4444; }
  .goal-input-row { display: flex; align-items: center; gap: 10px; }
  .goal-input-row input {
    width: 80px; height: 42px; text-align: center; border: 2px solid var(--emerald-200); border-radius: 10px;
    font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1rem; font-weight: 800;
    color: var(--emerald-800); background: rgba(236, 253, 245, 0.6); outline: none;
  }
  .goal-input-row input:focus { border-color: var(--emerald-500); }
  .goal-input-row span { font-size: 0.84rem; color: var(--gray-600); font-weight: 500; }
  .empty-state { text-align: center; padding: 40px 20px; color: var(--gray-400); }
  .empty-state svg { width: 44px; height: 44px; fill: var(--emerald-200); margin-bottom: 12px; display: block; margin: 0 auto 12px; }
  .empty-state p { font-size: 0.88rem; font-weight: 600; }
  .empty-state small { font-size: 0.77rem; font-weight: 500; }

  .celebration-overlay {
    position: fixed; inset: 0; background: rgba(6, 78, 59, 0.8);
    display: flex; align-items: center; justify-content: center; z-index: 100;
    animation: fadeIn 0.3s ease;
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  }
  .celebration-card {
    background: var(--white); border-radius: 28px; padding: 44px 36px;
    text-align: center; max-width: 380px; width: 90%;
    box-shadow: 0 24px 64px rgba(0,0,0,0.25);
    animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .celebration-card .trophy { font-size: 2.6rem; margin-bottom: 14px; }
  .celebration-card h2 { font-family: 'Amiri', serif; font-size: 1.4rem; color: var(--emerald-800); margin-bottom: 8px; }
  .celebration-card p { color: var(--gray-500); font-size: 0.86rem; margin-bottom: 22px; line-height: 1.5; font-weight: 500; }

  .hidden { display: none !important; }
  #mainContent { padding-bottom: 100px; }

  @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes scaleIn { from { opacity: 0; transform: scale(0.88); } to { opacity: 1; transform: scale(1); } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.06); } }
  .pulse { animation: pulse 0.3s ease; }
  .spinner {
    width: 32px; height: 32px; border: 3px solid var(--emerald-200);
    border-top-color: var(--emerald-600); border-radius: 50%; animation: spin 0.8s linear infinite;
  }

  @media (max-width: 400px) {
    .quran-text { font-size: 1.25rem; line-height: 2.3; }
    #app { padding: 10px 10px 30px; }
    .card { padding: 18px; }
    .completion-grid { grid-template-columns: repeat(15, 1fr); }
    .bottom-nav { width: calc(100% - 24px); bottom: 12px; }
  }
</style>
</head>
<body>
<div class="ambient-bg"></div>
<div class="geometric-bg"></div>
<div id="app">
  <div class="app-header">
    <div class="logo-icon">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
    </div>
    <h1>Tarteel</h1>
    <p>Quran Memorization Companion</p>
  </div>
  <div id="mainContent"></div>
</div>
<div class="bottom-nav" id="bottomNav">
  <button class="nav-item active" data-tab="home">
    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span>
  </button>
  <button class="nav-item" data-tab="review" style="position:relative;">
    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><span>Review</span>
    <div class="nav-badge hidden" id="reviewBadge">0</div>
  </button>
  <button class="nav-item" data-tab="progress">
    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>Progress</span>
  </button>
  <button class="nav-item" data-tab="settings">
    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg><span>Settings</span>
  </button>
</div>

<script>
const API_BASE='https://api.alquran.cloud/v1';
const RECITERS=[
  {id:'ar.alafasy',name:'Mishary Rashid Alafasy'},
  {id:'ar.abdulbasitmurattal',name:'Abdul Basit (Murattal)'},
  {id:'ar.husary',name:'Mahmoud Khalil Al-Husary'},
  {id:'ar.minshawi',name:'Mohamed Siddiq El-Minshawi'},
  {id:'ar.abdurrahmaansudais',name:'Abdurrahmaan As-Sudais'},
];
const SURAH_INFO=[null,
{n:"Al-Fatihah",p:[1,1]},{n:"Al-Baqarah",p:[2,49]},{n:"Aal-Imran",p:[50,76]},{n:"An-Nisa",p:[77,106]},{n:"Al-Ma'idah",p:[106,127]},
{n:"Al-An'am",p:[128,150]},{n:"Al-A'raf",p:[151,176]},{n:"Al-Anfal",p:[177,186]},{n:"At-Tawbah",p:[187,207]},{n:"Yunus",p:[208,221]},
{n:"Hud",p:[221,235]},{n:"Yusuf",p:[235,248]},{n:"Ar-Ra'd",p:[249,255]},{n:"Ibrahim",p:[255,261]},{n:"Al-Hijr",p:[262,267]},
{n:"An-Nahl",p:[267,281]},{n:"Al-Isra",p:[282,293]},{n:"Al-Kahf",p:[293,304]},{n:"Maryam",p:[305,312]},{n:"Ta-Ha",p:[312,321]},
{n:"Al-Anbiya",p:[322,331]},{n:"Al-Hajj",p:[332,341]},{n:"Al-Mu'minun",p:[342,349]},{n:"An-Nur",p:[350,359]},{n:"Al-Furqan",p:[359,366]},
{n:"Ash-Shu'ara",p:[367,376]},{n:"An-Naml",p:[377,385]},{n:"Al-Qasas",p:[385,396]},{n:"Al-Ankabut",p:[396,404]},{n:"Ar-Rum",p:[404,410]},
{n:"Luqman",p:[411,414]},{n:"As-Sajdah",p:[415,417]},{n:"Al-Ahzab",p:[418,427]},{n:"Saba",p:[428,434]},{n:"Fatir",p:[434,440]},
{n:"Ya-Sin",p:[440,445]},{n:"As-Saffat",p:[446,452]},{n:"Sad",p:[453,458]},{n:"Az-Zumar",p:[458,467]},{n:"Ghafir",p:[467,476]},
{n:"Fussilat",p:[477,482]},{n:"Ash-Shura",p:[483,489]},{n:"Az-Zukhruf",p:[489,495]},{n:"Ad-Dukhan",p:[496,498]},{n:"Al-Jathiyah",p:[499,502]},
{n:"Al-Ahqaf",p:[502,506]},{n:"Muhammad",p:[507,510]},{n:"Al-Fath",p:[511,515]},{n:"Al-Hujurat",p:[515,517]},{n:"Qaf",p:[518,520]},
{n:"Adh-Dhariyat",p:[520,523]},{n:"At-Tur",p:[523,525]},{n:"An-Najm",p:[526,528]},{n:"Al-Qamar",p:[528,531]},{n:"Ar-Rahman",p:[531,534]},
{n:"Al-Waqi'ah",p:[534,537]},{n:"Al-Hadid",p:[537,541]},{n:"Al-Mujadilah",p:[542,545]},{n:"Al-Hashr",p:[545,548]},{n:"Al-Mumtahanah",p:[549,551]},
{n:"As-Saff",p:[551,552]},{n:"Al-Jumu'ah",p:[553,554]},{n:"Al-Munafiqun",p:[554,555]},{n:"At-Taghabun",p:[556,557]},{n:"At-Talaq",p:[558,559]},
{n:"At-Tahrim",p:[560,561]},{n:"Al-Mulk",p:[562,564]},{n:"Al-Qalam",p:[564,566]},{n:"Al-Haqqah",p:[566,568]},{n:"Al-Ma'arij",p:[568,570]},
{n:"Nuh",p:[570,571]},{n:"Al-Jinn",p:[572,573]},{n:"Al-Muzzammil",p:[574,575]},{n:"Al-Muddaththir",p:[575,577]},{n:"Al-Qiyamah",p:[577,578]},
{n:"Al-Insan",p:[578,580]},{n:"Al-Mursalat",p:[580,581]},{n:"An-Naba",p:[582,583]},{n:"An-Nazi'at",p:[583,584]},{n:"Abasa",p:[585,585]},
{n:"At-Takwir",p:[586,586]},{n:"Al-Infitar",p:[587,587]},{n:"Al-Mutaffifin",p:[587,589]},{n:"Al-Inshiqaq",p:[589,590]},{n:"Al-Buruj",p:[590,590]},
{n:"At-Tariq",p:[591,591]},{n:"Al-A'la",p:[591,592]},{n:"Al-Ghashiyah",p:[592,592]},{n:"Al-Fajr",p:[593,594]},{n:"Al-Balad",p:[594,594]},
{n:"Ash-Shams",p:[595,595]},{n:"Al-Layl",p:[595,596]},{n:"Ad-Duha",p:[596,596]},{n:"Ash-Sharh",p:[596,596]},{n:"At-Tin",p:[597,597]},
{n:"Al-Alaq",p:[597,597]},{n:"Al-Qadr",p:[598,598]},{n:"Al-Bayyinah",p:[598,599]},{n:"Az-Zalzalah",p:[599,599]},{n:"Al-Adiyat",p:[599,600]},
{n:"Al-Qari'ah",p:[600,600]},{n:"At-Takathur",p:[600,600]},{n:"Al-Asr",p:[601,601]},{n:"Al-Humazah",p:[601,601]},{n:"Al-Fil",p:[601,601]},
{n:"Quraysh",p:[602,602]},{n:"Al-Ma'un",p:[602,602]},{n:"Al-Kawthar",p:[602,602]},{n:"Al-Kafirun",p:[603,603]},{n:"An-Nasr",p:[603,603]},
{n:"Al-Masad",p:[603,603]},{n:"Al-Ikhlas",p:[604,604]},{n:"Al-Falaq",p:[604,604]},{n:"An-Nas",p:[604,604]}
];
const JUZ_PAGES=[null,[1,21],[22,41],[42,61],[62,81],[82,101],[102,121],[122,141],[142,161],[162,181],[182,201],
[202,221],[222,241],[242,261],[262,281],[282,301],[302,321],[322,341],[342,361],[362,381],[382,401],
[402,421],[422,441],[442,461],[462,481],[482,501],[502,521],[522,541],[542,561],[562,581],[582,604]];
const REVIEW_STAGES=[1,3,7,14,30,90];

function loadData(){try{return JSON.parse(localStorage.getItem('tarteel_data'))||defaultData();}catch{return defaultData();}}
function defaultData(){return{completedPages:{},streak:{current:0,lastActiveDate:null},savedSession:null,weeklyGoal:5,reciterId:'ar.alafasy',lastPage:''};}
function saveData(){localStorage.setItem('tarteel_data',JSON.stringify(data));}
let data=loadData();

let app={currentTab:'home',pageData:null,surahSegments:[],currentSegmentIndex:0,checkTranslation:false,listenCount:0,sections:[],currentSectionIndex:0,repetitionCount:0,sectionCompleted:[],targetReps:50,memScreen:false,pageNumber:null};
const $=s=>document.querySelector(s);
const $main=()=>$('#mainContent');
const ICONS={
  check:'<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',
  play:'<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>',
  pause:'<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>',
  back:'<svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>',
  eye:'<svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>',
  arrow:'<svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>',
};

function todayStr(){return new Date().toISOString().split('T')[0];}
function daysBetween(a,b){return Math.floor((new Date(b)-new Date(a))/(864e5));}
function getNextReviewDate(stage,from){const d=new Date(from);d.setDate(d.getDate()+(stage<REVIEW_STAGES.length?REVIEW_STAGES[stage]:90));return d.toISOString().split('T')[0];}
function getDueReviews(){const t=todayStr();return Object.entries(data.completedPages).filter(([,i])=>i.nextReview&&i.nextReview<=t).map(([p,i])=>({page:+p,...i})).sort((a,b)=>a.page-b.page);}
function getPagesThisWeek(){const t=new Date(),d=t.getDay(),s=new Date(t);s.setDate(t.getDate()-(d===0?6:d-1));s.setHours(0,0,0,0);const ss=s.toISOString().split('T')[0];return Object.entries(data.completedPages).filter(([,i])=>i.completedAt>=ss).length;}
function updateStreak(){const t=todayStr();if(data.streak.lastActiveDate===t)return;if(data.streak.lastActiveDate){const d=daysBetween(data.streak.lastActiveDate,t);if(d===1)data.streak.current++;else if(d>1)data.streak.current=1;}else data.streak.current=1;data.streak.lastActiveDate=t;saveData();}
function getNextUnmemorizedPage(){for(let i=1;i<=604;i++)if(!data.completedPages[i])return i;return null;}
function getCompletedCount(){return Object.keys(data.completedPages).length;}

function initNav(){document.querySelectorAll('.nav-item').forEach(b=>{b.addEventListener('click',()=>{if(app.memScreen){if(!confirm('Leave memorization? Progress is auto-saved.'))return;autoSaveSession();}app.memScreen=false;app.currentTab=b.dataset.tab;setActiveTab(b.dataset.tab);renderTab(b.dataset.tab);});});updateReviewBadge();}
function setActiveTab(t){document.querySelectorAll('.nav-item').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));}
function updateReviewBadge(){const d=getDueReviews().length;const b=$('#reviewBadge');if(d>0){b.classList.remove('hidden');b.textContent=d>9?'9+':d;}else b.classList.add('hidden');}
function showBottomNav(s){$('#bottomNav').style.display=s?'flex':'none';}
function renderTab(t){showBottomNav(true);switch(t){case'home':renderHome();break;case'review':renderReview();break;case'progress':renderProgress();break;case'settings':renderSettings();break;}}

async function fetchPage(pn){
  const tr=await fetch(`${API_BASE}/page/${pn}/quran-uthmani`);const td=await tr.json();
  if(td.code!==200)throw new Error('Not found');
  const ar=await fetch(`${API_BASE}/page/${pn}/${data.reciterId}`);const ad=await ar.json();
  return td.data.ayahs.map((a,i)=>({number:a.number,numberInSurah:a.numberInSurah,surahNumber:a.surah.number,surahName:a.surah.englishName,surahNameAr:a.surah.name,text:a.text,audio:ad.data.ayahs[i]?.audio||''}));
}
function buildSurahSegments(ay){const s=[];let c=null;for(const a of ay){if(!c||c.surahNumber!==a.surahNumber){if(c)s.push(c);c={surahNumber:a.surahNumber,surahName:a.surahName,surahNameAr:a.surahNameAr,ayahs:[],audioUrls:[]};}c.ayahs.push(a);c.audioUrls.push(a.audio);}if(c)s.push(c);return s;}
function buildSections(seg){const a=seg.ayahs,t=a.length;if(t<=2)return[{label:`Full â€” ${seg.surahName}`,ayahs:[...a],type:'whole'}];const t1=Math.ceil(t/3),t2=Math.ceil(2*t/3);return[{label:'First Third',ayahs:a.slice(0,t1),type:'third'},{label:'Second Third',ayahs:a.slice(t1,t2),type:'third'},{label:'Third Third',ayahs:a.slice(t2),type:'third'},{label:'Full Page',ayahs:[...a],type:'whole'}];}
function renderAyahsHtml(ay){return ay.map(a=>`${a.text} <span class="ayah-number">${a.numberInSurah}</span>`).join(' ');}

function autoSaveSession(){if(!app.memScreen){data.savedSession=null;saveData();return;}data.savedSession={pageNumber:app.pageNumber,segmentIndex:app.currentSegmentIndex,sectionIndex:app.currentSectionIndex,repetitionCount:app.repetitionCount,sectionCompleted:app.sectionCompleted,timestamp:Date.now()};saveData();}
function clearSavedSession(){data.savedSession=null;saveData();}

function renderHome(){
  app.currentTab='home';setActiveTab('home');updateReviewBadge();
  const streak=data.streak.current,due=getDueReviews(),pw=getPagesThisWeek(),goal=data.weeklyGoal,gp=Math.min(100,Math.round(pw/goal*100)),np=getNextUnmemorizedPage(),ses=data.savedSession,cc=getCompletedCount();
  let h='';
  if(streak>0)h+=`<div class="streak-banner"><span class="flame">ðŸ”¥</span><div class="streak-text">${streak} day streak!<small>Consistency is key</small></div></div>`;
  if(ses){const el=Date.now()-ses.timestamp,hr=Math.floor(el/36e5),ts=hr<1?'just now':hr<24?hr+'h ago':Math.floor(hr/24)+'d ago';h+=`<button class="quick-continue" id="resumeSession"><div class="qc-icon"><svg viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg></div><div class="qc-text"><h4>Resume â€” Page ${ses.pageNumber}</h4><p>Section ${ses.sectionIndex+1}, Rep ${ses.repetitionCount}/50 Â· ${ts}</p></div><div class="qc-arrow">${ICONS.arrow}</div></button>`;}
  else if(np&&cc>0)h+=`<button class="quick-continue" id="quickContinue"><div class="qc-icon"><svg viewBox="0 0 24 24" fill="white"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div><div class="qc-text"><h4>Continue â†’ Page ${np}</h4><p>${cc} pages memorized</p></div><div class="qc-arrow">${ICONS.arrow}</div></button>`;
  if(due.length>0)h+=`<div class="review-banner" id="goReview"><span class="rb-icon">ðŸ“‹</span><div class="rb-text">${due.length} page${due.length>1?'s':''} due for review<small>Tap to start</small></div><span class="rb-arrow">â€º</span></div>`;
  h+=`<div class="card"><div class="card-title"><div class="icon">ðŸ“–</div> Memorize a Page</div><div class="page-selector"><input type="number" class="input-field" id="pageInput" min="1" max="604" placeholder="Page (1â€“604)" value="${data.lastPage||''}"><button class="btn btn-primary" id="loadPageBtn">Load</button></div><div class="error-msg" id="errorMsg"></div>${goal>0?`<div class="goal-bar"><div class="goal-header"><span>${pw}/${goal} this week</span><small>${gp}%</small></div><div class="goal-track"><div class="goal-fill" style="width:${gp}%"></div></div></div>`:''}</div>`;
  $main().innerHTML=h;
  const lb=$('#loadPageBtn'),pi=$('#pageInput'),em=$('#errorMsg');
  const doLoad=async(po)=>{const pn=po||parseInt(pi.value);if(!pn||pn<1||pn>604){if(em){em.textContent='Enter a valid page (1â€“604).';em.style.display='block';}return;}if(em)em.style.display='none';app.pageNumber=pn;data.lastPage=pn;saveData();if(lb){lb.disabled=true;lb.textContent='Loadingâ€¦';}try{const ay=await fetchPage(pn);app.pageData=ay;app.surahSegments=buildSurahSegments(ay);app.currentSegmentIndex=0;app.checkTranslation=false;app.listenCount=0;showBottomNav(false);if(app.surahSegments.length>1)renderSegmentPicker();else renderChecklist();}catch{if(em){em.textContent='Failed to load. Check connection.';em.style.display='block';}if(lb){lb.disabled=false;lb.textContent='Load';}}};
  if(lb)lb.addEventListener('click',()=>doLoad());
  if(pi)pi.addEventListener('keydown',e=>{if(e.key==='Enter')doLoad();});
  const qc=$('#quickContinue');if(qc)qc.addEventListener('click',()=>doLoad(np));
  const rs=$('#resumeSession');if(rs)rs.addEventListener('click',()=>resumeSavedSession());
  const gr=$('#goReview');if(gr)gr.addEventListener('click',()=>{app.currentTab='review';setActiveTab('review');renderReview();});
}

async function resumeSavedSession(){const s=data.savedSession;if(!s)return;app.pageNumber=s.pageNumber;$main().innerHTML='<div style="display:flex;flex-direction:column;align-items:center;padding:60px 0;gap:14px;"><div class="spinner"></div><span style="font-size:0.85rem;color:var(--emerald-600);font-weight:500;">Resumingâ€¦</span></div>';showBottomNav(false);try{const ay=await fetchPage(s.pageNumber);app.pageData=ay;app.surahSegments=buildSurahSegments(ay);app.currentSegmentIndex=s.segmentIndex;app.sections=buildSections(app.surahSegments[app.currentSegmentIndex]);app.currentSectionIndex=s.sectionIndex;app.repetitionCount=s.repetitionCount;app.sectionCompleted=s.sectionCompleted||app.sections.map(()=>false);app.memScreen=true;renderMemorize();}catch{clearSavedSession();showBottomNav(true);renderHome();}}

function renderSegmentPicker(){
  $main().innerHTML=`<button class="back-btn" id="backBtn">${ICONS.back} Back</button><div class="card"><div class="card-title"><div class="icon">ðŸ“„</div> Page ${app.pageNumber} â€” Multiple Surahs</div><p style="font-size:0.82rem;color:var(--gray-500);margin-bottom:14px;line-height:1.5;">Each surah section is memorized separately.</p><div id="segmentList"></div><button class="btn btn-secondary btn-full btn-sm" id="memAllBtn" style="margin-top:10px;">Memorize All Sequentially</button></div>`;
  const sl=$('#segmentList');
  app.surahSegments.forEach((seg,i)=>{const d=document.createElement('div');d.className='surah-segment-card';d.innerHTML=`<h4>${seg.surahNameAr} â€” ${seg.surahName}</h4><p>${seg.ayahs.length} ayah${seg.ayahs.length>1?'s':''} (${seg.ayahs[0].numberInSurah}â€“${seg.ayahs[seg.ayahs.length-1].numberInSurah})</p>`;d.addEventListener('click',()=>{app.currentSegmentIndex=i;app.checkTranslation=false;app.listenCount=0;renderChecklist();});sl.appendChild(d);});
  $('#backBtn').addEventListener('click',()=>{showBottomNav(true);renderHome();});
  $('#memAllBtn').addEventListener('click',()=>{app.currentSegmentIndex=0;app.checkTranslation=false;app.listenCount=0;renderChecklist();});
}

function renderChecklist(){
  showBottomNav(false);app.memScreen=false;
  const seg=app.surahSegments[app.currentSegmentIndex],multi=app.surahSegments.length>1;
  $main().innerHTML=`<button class="back-btn" id="backBtn">${ICONS.back} ${multi?'Segments':'Back'}</button><div class="card"><div class="card-title"><div class="icon">âœ…</div> Pre-Memorization Checklist</div><div class="surah-header-display"><h3>${seg.surahNameAr} â€” ${seg.surahName}</h3><p>Ayahs ${seg.ayahs[0].numberInSurah}â€“${seg.ayahs[seg.ayahs.length-1].numberInSurah} Â· Page ${app.pageNumber}</p></div>
  <div class="checklist-item ${app.checkTranslation?'completed':''}" id="trCheck"><div class="check-circle">${ICONS.check}</div><div class="check-label"><h4>Read Translation / Tafseer</h4><p>Read the meaning to aid memorization.</p></div></div>
  <div class="checklist-item ${app.listenCount>=3?'completed':''}" id="liCheck"><div class="check-circle">${ICONS.check}</div><div class="check-label"><h4>Listen to Audio (3Ã—)</h4><p>Listen carefully before beginning.</p><div><div class="listen-counter"><div class="listen-dots">${[1,2,3].map(n=>`<div class="listen-dot ${app.listenCount>=n?'filled':''}">${n}</div>`).join('')}</div><span style="font-size:0.76rem;color:var(--gray-500);font-weight:600;">${app.listenCount}/3</span></div><div class="audio-player-mini"><button class="play-btn" id="apBtn">${ICONS.play}</button><div class="audio-info">Play recitation<small>${RECITERS.find(r=>r.id===data.reciterId)?.name||''}</small></div><button class="mark-listened-btn" id="mlBtn" ${app.listenCount>=3?'disabled style="opacity:0.4"':''}>Mark Listened</button></div></div></div></div>
  <button class="btn btn-primary btn-full" id="beginBtn" ${!(app.checkTranslation&&app.listenCount>=3)?'disabled':''} style="margin-top:14px;">Begin Memorization</button></div>`;
  $('#trCheck').addEventListener('click',()=>{app.checkTranslation=!app.checkTranslation;renderChecklist();});
  let aq=seg.audioUrls,ai=0,ae=new Audio(),pl=false;
  function ps(){if(ai>=aq.length){pl=false;ai=0;ub();return;}ae.src=aq[ai];ae.play().catch(()=>{});ae.onended=()=>{ai++;ps();};}
  function ub(){const b=$('#apBtn');if(b)b.innerHTML=pl?ICONS.pause:ICONS.play;}
  $('#apBtn').addEventListener('click',()=>{if(pl){ae.pause();pl=false;}else{pl=true;ps();}ub();});
  $('#mlBtn').addEventListener('click',()=>{if(app.listenCount<3){app.listenCount++;ae.pause();pl=false;ai=0;renderChecklist();}});
  $('#beginBtn').addEventListener('click',()=>startMemorization());
  $('#backBtn').addEventListener('click',()=>{ae.pause();if(multi)renderSegmentPicker();else{showBottomNav(true);renderHome();}});
}

function startMemorization(){const seg=app.surahSegments[app.currentSegmentIndex];app.sections=buildSections(seg);app.currentSectionIndex=0;app.repetitionCount=0;app.sectionCompleted=app.sections.map(()=>false);app.memScreen=true;renderMemorize();}

function renderMemorize(){
  showBottomNav(false);app.memScreen=true;autoSaveSession();
  const seg=app.surahSegments[app.currentSegmentIndex],sec=app.sections[app.currentSectionIndex],isW=sec.type==='whole',ts=app.sections.length,si=app.currentSectionIndex;
  $main().innerHTML=`<button class="back-btn" id="backBtn">${ICONS.back} Checklist</button>
  <div class="card" style="padding:14px 14px 18px;"><div class="card-title" style="margin-bottom:10px;"><div class="icon">ðŸ“</div> ${seg.surahName}</div>
  <div class="sections-nav">${app.sections.map((s,i)=>{let c='section-tab';if(i===si)c+=' active';else if(app.sectionCompleted[i])c+=' completed';const ic=app.sectionCompleted[i]?'<svg class="check-sm" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>':'';return`<div class="${c}">${ic}${s.label}</div>`;}).join('')}</div>
  <div class="stage-progress">${app.sections.map((s,i)=>{let d='stage-dot';if(i===si)d+=' active';else if(app.sectionCompleted[i])d+=' completed';const l=i<si?'stage-line completed':'stage-line';return(i>0?`<div class="${l}"></div>`:'')+`<div class="${d}"></div>`;}).join('')}</div></div>

  <div class="quran-text-container">${sec.ayahs[0].numberInSurah===1&&sec.ayahs[0].surahNumber!==1&&sec.ayahs[0].surahNumber!==9?`<div class="surah-header-display"><h3>${seg.surahNameAr} â€” ${seg.surahName}</h3></div><div class="bismillah">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙŽÙ‘Ù‡Ù Ù±Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…ÙŽÙ€Ù°Ù†Ù Ù±Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ…Ù</div>`:''}<div class="quran-text">${renderAyahsHtml(sec.ayahs)}</div></div>

  <div class="card mem-tracker"><div class="mem-stage-label">${isW?'Final Review â€” Full Section':`Part ${si+1} of ${ts-1}`}</div><div class="mem-section-label">${sec.label}</div>
  <div class="counter-display"><span class="counter-number" id="cNum">${app.repetitionCount}</span><span class="counter-total">/ ${app.targetReps}</span></div>
  <div class="progress-bar-container"><div class="progress-bar-fill" id="pBar" style="width:${app.repetitionCount/app.targetReps*100}%"></div></div>
  <div class="progress-info"><span id="pD">${app.repetitionCount} repetitions</span><span id="pL">${app.targetReps-app.repetitionCount} remaining</span></div>
  <button class="counter-btn" id="repBtn">I've Read It â€” Tap to Count</button>
  <div class="audio-player-mini" style="margin-top:14px;"><button class="play-btn" id="saBtn">${ICONS.play}</button><div class="audio-info">Play this section<small>Listen while memorizing</small></div></div>
  <div class="reset-row"><button class="reset-btn" id="rcBtn">Reset Counter</button></div></div>`;

  $('#repBtn').addEventListener('click',()=>{app.repetitionCount++;const c=$('#cNum'),b=$('#pBar'),d=$('#pD'),l=$('#pL');if(c){c.textContent=app.repetitionCount;c.classList.add('pulse');setTimeout(()=>c.classList.remove('pulse'),300);}if(b)b.style.width=app.repetitionCount/app.targetReps*100+'%';if(d)d.textContent=app.repetitionCount+' repetitions';if(l)l.textContent=Math.max(0,app.targetReps-app.repetitionCount)+' remaining';autoSaveSession();if(app.repetitionCount>=app.targetReps)handleSectionComplete();});

  let sq=sec.ayahs.map(a=>a.audio),si2=0,sa=new Audio(),sp=false;
  function psa(){if(si2>=sq.length){sp=false;si2=0;const b=$('#saBtn');if(b)b.innerHTML=ICONS.play;return;}sa.src=sq[si2];sa.play().catch(()=>{});sa.onended=()=>{si2++;psa();};}
  $('#saBtn').addEventListener('click',()=>{if(sp){sa.pause();sp=false;const b=$('#saBtn');if(b)b.innerHTML=ICONS.play;}else{sp=true;const b=$('#saBtn');if(b)b.innerHTML=ICONS.pause;psa();}});
  $('#rcBtn').addEventListener('click',()=>{if(confirm('Reset counter?')){app.repetitionCount=0;autoSaveSession();renderMemorize();}});
  $('#backBtn').addEventListener('click',()=>{sa.pause();autoSaveSession();app.memScreen=false;renderChecklist();});
}

function handleSectionComplete(){
  app.sectionCompleted[app.currentSectionIndex]=true;autoSaveSession();
  if(app.sectionCompleted.every(Boolean)){
    if(app.currentSegmentIndex<app.surahSegments.length-1){showOverlay('ðŸŒŸ','Section Complete!','Moving to next surah section.','Continue',()=>{app.currentSegmentIndex++;app.checkTranslation=false;app.listenCount=0;renderChecklist();});}
    else{markPageComplete(app.pageNumber);clearSavedSession();app.memScreen=false;showOverlay('ðŸ†','Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡!',`Page ${app.pageNumber} memorized! May Allah keep it firm in your heart.`,'Memorize Another',()=>{showBottomNav(true);renderHome();},'Repeat Page',()=>{app.currentSegmentIndex=0;app.checkTranslation=false;app.listenCount=0;if(app.surahSegments.length>1)renderSegmentPicker();else renderChecklist();});}
    return;
  }
  const nx=app.sectionCompleted.findIndex((c,i)=>!c);if(nx!==-1){app.currentSectionIndex=nx;app.repetitionCount=0;renderMemorize();}
}

function markPageComplete(pn){const t=todayStr();data.completedPages[pn]={completedAt:t,lastReviewed:t,reviewStage:0,nextReview:getNextReviewDate(0,t)};updateStreak();saveData();updateReviewBadge();}

function showOverlay(em,ti,msg,b1t,b1f,b2t,b2f){const o=document.createElement('div');o.className='celebration-overlay';o.innerHTML=`<div class="celebration-card"><div class="trophy">${em}</div><h2>${ti}</h2><p>${msg}</p><button class="btn btn-primary btn-full" id="ov1" style="margin-bottom:8px;">${b1t}</button>${b2t?`<button class="btn btn-outline btn-full" id="ov2">${b2t}</button>`:''}</div>`;document.body.appendChild(o);o.querySelector('#ov1').addEventListener('click',()=>{o.remove();b1f();});if(b2t)o.querySelector('#ov2').addEventListener('click',()=>{o.remove();b2f();});}

function renderReview(){
  const due=getDueReviews();updateReviewBadge();
  if(!due.length){$main().innerHTML=`<div class="card"><div class="card-title"><div class="icon">ðŸ“‹</div> Revision Queue</div><div class="empty-state"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><p>No reviews due!</p><small>Pages will appear here on schedule.</small></div></div><div class="info-box"><div style="min-width:18px;">${ICONS.eye}</div><p>Schedule: 1d â†’ 3d â†’ 7d â†’ 14d â†’ 30d â†’ 3 months â†’ every 3 months permanently.</p></div>`;return;}
  $main().innerHTML=`<div class="card"><div class="card-title"><div class="icon">ðŸ“‹</div> Revision â€” ${due.length} Due</div><p style="font-size:0.82rem;color:var(--gray-500);margin-bottom:14px;line-height:1.5;">Recite from memory, then reveal to check. Pass if fewer than 3 errors.</p><div id="rl"></div></div>`;
  const rl=$('#rl');due.forEach(it=>{const d=document.createElement('div');d.className='surah-segment-card';const st=it.reviewStage,lb=st<REVIEW_STAGES.length?`Review #${st+1}`:'Recurring (3 months)';d.innerHTML=`<h4>Page ${it.page}</h4><p>${lb}</p>`;d.addEventListener('click',()=>startReview(it.page));rl.appendChild(d);});
}

async function startReview(pn){
  showBottomNav(false);$main().innerHTML='<div style="display:flex;flex-direction:column;align-items:center;padding:60px 0;gap:14px;"><div class="spinner"></div><span style="font-size:0.85rem;color:var(--emerald-600);">Loadingâ€¦</span></div>';
  try{const ay=await fetchPage(pn);renderReviewPage(pn,ay);}catch{showBottomNav(true);renderReview();}
}

function renderReviewPage(pn,ay){
  const th=renderAyahsHtml(ay);let rev=false;
  $main().innerHTML=`<button class="back-btn" id="bk">${ICONS.back} Review Queue</button>
  <div class="review-card"><div class="card-title"><div class="icon">ðŸ“‹</div> Reviewing Page ${pn}</div>
  <p style="font-size:0.84rem;color:var(--gray-600);margin-bottom:16px;line-height:1.5;">Recite this page from memory first, then tap below to reveal and check yourself.</p>
  <div id="tArea"><div class="text-hidden-overlay" id="revBtn"><div class="reveal-text">${ICONS.eye}<p>Tap to reveal text</p><small>Recite from memory first</small></div></div></div>
  <div id="rActs" style="display:none;" class="review-actions">
    <button class="btn btn-sm" id="passBtn" style="flex:1;background:var(--emerald-600);color:white;">âœ“ &lt; 3 errors</button>
    <button class="btn btn-outline btn-sm" id="failBtn" style="flex:1;border-color:#fbbf24;color:#92400e;">âœ— Needs practice</button>
  </div></div>`;
  $('#revBtn').addEventListener('click',()=>{if(rev)return;rev=true;$('#tArea').innerHTML=`<div class="quran-text-container" style="margin:0;"><div class="quran-text">${th}</div></div>`;$('#rActs').style.display='flex';});
  $('#bk').addEventListener('click',()=>{showBottomNav(true);renderReview();});
  document.addEventListener('click',function h(e){
    if(e.target.id==='passBtn'||e.target.closest('#passBtn')){document.removeEventListener('click',h);passReview(pn);}
    if(e.target.id==='failBtn'||e.target.closest('#failBtn')){document.removeEventListener('click',h);failReview(pn);}
  });
}

function passReview(pn){const i=data.completedPages[pn];if(!i)return;const t=todayStr();i.reviewStage++;i.lastReviewed=t;i.nextReview=getNextReviewDate(i.reviewStage,t);saveData();const nxt=i.reviewStage<REVIEW_STAGES.length?REVIEW_STAGES[i.reviewStage]+' days':'3 months';showOverlay('âœ…','Review Passed!',`Page ${pn} â€” next review in ${nxt}.`,'Continue',()=>{showBottomNav(true);renderReview();});}
function failReview(pn){const i=data.completedPages[pn];if(!i)return;const t=todayStr();i.lastReviewed=t;const tm=new Date();tm.setDate(tm.getDate()+1);i.nextReview=tm.toISOString().split('T')[0];saveData();showOverlay('ðŸ”„','Keep Practicing',`Page ${pn} will come back tomorrow.`,'Continue',()=>{showBottomNav(true);renderReview();});}

function renderProgress(){
  let vm='grid';
  function render(){
    const cc=getCompletedCount(),pct=(cc/604*100).toFixed(1);
    let h=`<div class="card"><div class="card-title"><div class="icon">ðŸ“Š</div> Your Progress</div><div style="text-align:center;margin-bottom:16px;"><div style="font-size:2.2rem;font-weight:800;color:var(--emerald-700);">${cc}</div><div style="font-size:0.82rem;color:var(--gray-500);font-weight:500;">of 604 pages (${pct}%)</div><div class="progress-bar-container" style="margin-top:10px;"><div class="progress-bar-fill" style="width:${pct}%"></div></div></div>
    <div class="progress-tabs"><button class="progress-tab ${vm==='grid'?'active':''}" data-v="grid">Grid</button><button class="progress-tab ${vm==='juz'?'active':''}" data-v="juz">By Juz</button><button class="progress-tab ${vm==='surah'?'active':''}" data-v="surah">By Surah</button></div><div id="pv"></div></div>`;
    $main().innerHTML=h;
    document.querySelectorAll('.progress-tab').forEach(t=>t.addEventListener('click',()=>{vm=t.dataset.v;render();}));
    if(vm==='grid')rGrid();else if(vm==='juz')rJuz();else rSurah();
  }
  function rGrid(){
    const pv=$('#pv'),ds=new Set(getDueReviews().map(r=>r.page));let c='';
    for(let i=1;i<=604;i++){const m=!!data.completedPages[i],d=ds.has(i);let cl='grid-cell';if(d)cl+=' review-due';else if(m)cl+=' memorized';c+=`<button class="${cl}"><span class="tooltip">Page ${i}</span></button>`;}
    pv.innerHTML=`<div class="completion-grid">${c}</div><div class="grid-legend"><div class="grid-legend-item"><div class="swatch" style="background:var(--emerald-100);"></div>Not started</div><div class="grid-legend-item"><div class="swatch" style="background:var(--emerald-500);"></div>Memorized</div><div class="grid-legend-item"><div class="swatch" style="background:var(--amber-500);"></div>Review due</div></div>`;
  }
  function rJuz(){
    const pv=$('#pv');let it='';
    for(let j=1;j<=30;j++){const[s,e]=JUZ_PAGES[j],t=e-s+1;let d=0;for(let p=s;p<=e;p++)if(data.completedPages[p])d++;const pc=t>0?Math.round(d/t*100):0;it+=`<div class="progress-list-item"><div><div class="pli-name">Juz ${j}</div><div class="pli-detail">Pages ${s}â€“${e} Â· ${d}/${t}</div></div><div class="pli-bar"><div class="pli-bar-track"><div class="pli-bar-fill" style="width:${pc}%"></div></div><div class="pli-bar-pct">${pc}%</div></div></div>`;}
    pv.innerHTML=it;
  }
  function rSurah(){
    const pv=$('#pv');let it='';
    for(let s=1;s<=114;s++){const inf=SURAH_INFO[s];if(!inf)continue;const[st,en]=inf.p,t=en-st+1;let d=0;for(let p=st;p<=en;p++)if(data.completedPages[p])d++;const pc=t>0?Math.round(d/t*100):0;it+=`<div class="progress-list-item"><div><div class="pli-name">${s}. ${inf.n}</div><div class="pli-detail">Pages ${st}â€“${en} Â· ${d}/${t}</div></div><div class="pli-bar"><div class="pli-bar-track"><div class="pli-bar-fill" style="width:${pc}%"></div></div><div class="pli-bar-pct">${pc}%</div></div></div>`;}
    pv.innerHTML=`<div style="max-height:420px;overflow-y:auto;border-radius:var(--radius-sm);">${it}</div>`;
  }
  render();
}

function renderSettings(){
  $main().innerHTML=`
  <div class="card"><div class="card-title"><div class="icon">ðŸŽ§</div> Default Reciter</div><select class="reciter-select" id="rSel">${RECITERS.map(r=>`<option value="${r.id}" ${r.id===data.reciterId?'selected':''}>${r.name}</option>`).join('')}</select></div>
  <div class="card"><div class="card-title"><div class="icon">ðŸŽ¯</div> Weekly Goal</div><div class="goal-input-row"><input type="number" id="gIn" value="${data.weeklyGoal}" min="1" max="50"><span>pages per week</span><button class="btn btn-secondary btn-xs" id="gSave">Save</button></div></div>
  <div class="card"><div class="card-title"><div class="icon">ðŸ’¾</div> Data</div><p style="font-size:0.82rem;color:var(--gray-500);margin-bottom:12px;font-weight:500;">Progress is saved locally in this browser.</p><button class="btn btn-outline btn-full btn-sm" id="expBtn" style="margin-bottom:8px;">Export Progress (JSON)</button><button class="btn btn-sm btn-full" id="clrBtn" style="background:var(--red-50);color:var(--red-800);border:1px solid var(--red-200);">Reset All Progress</button></div>`;
  $('#rSel').addEventListener('change',e=>{data.reciterId=e.target.value;saveData();});
  $('#gSave').addEventListener('click',()=>{const v=parseInt($('#gIn').value);if(v&&v>0){data.weeklyGoal=v;saveData();renderSettings();}});
  $('#expBtn').addEventListener('click',()=>{const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`tarteel-${todayStr()}.json`;a.click();});
  $('#clrBtn').addEventListener('click',()=>{if(confirm('Delete ALL progress? This cannot be undone.')){if(confirm('Really delete everything?')){data=defaultData();saveData();renderSettings();}}});
}

initNav();renderHome();
window.addEventListener('beforeunload',()=>{if(app.memScreen)autoSaveSession();});
</script>
</body>
</html>